/*
 * Osc
 *
 * This code has been extracted from the Csound opcode "oscili".
 * It has been modified to work as a Soundpipe module.
 *
 * Original Author(s): Barry Vercoe, John FFitch, Robin Whittle
 * Year: 1991
 * Location: OOps/ugens2.c
 *
 */

#include <stdlib.h>
#include <math.h>
#include "soundpipe.h"

#include "stm32746g_discovery.h"

#define ARM_MATH_CM7
#include "arm_math.h"

float32_t lewave[600] = {0, 0.010467529296875, 0.02093505859375, 0.031402587890625, 0.0418701171875, 0.052337646484375, 0.062774658203125, 0.0732421875, 0.08367919921875, 0.0941162109375, 0.104522705078125, 0.11492919921875, 0.125335693359375, 0.135711669921875, 0.146087646484375, 0.15643310546875, 0.166778564453125, 0.177093505859375, 0.1873779296875, 0.197662353515625, 0.207916259765625, 0.2181396484375, 0.22833251953125, 0.238525390625, 0.248687744140625, 0.258819580078125, 0.2689208984375, 0.27899169921875, 0.289031982421875, 0.299041748046875, 0.30902099609375, 0.318939208984375, 0.328857421875, 0.338714599609375, 0.34857177734375, 0.358367919921875, 0.36810302734375, 0.377838134765625, 0.38751220703125, 0.397125244140625, 0.40673828125, 0.416259765625, 0.42578125, 0.435211181640625, 0.444610595703125, 0.4539794921875, 0.463287353515625, 0.4725341796875, 0.48175048828125, 0.490875244140625, 0.499969482421875, 0.509033203125, 0.51800537109375, 0.526947021484375, 0.535797119140625, 0.54461669921875, 0.553375244140625, 0.56207275390625, 0.570709228515625, 0.579254150390625, 0.5877685546875, 0.596221923828125, 0.604583740234375, 0.612884521484375, 0.621124267578125, 0.629302978515625, 0.63739013671875, 0.64544677734375, 0.653411865234375, 0.661285400390625, 0.669097900390625, 0.676849365234375, 0.684539794921875, 0.692108154296875, 0.69964599609375, 0.70709228515625, 0.714447021484375, 0.72174072265625, 0.72894287109375, 0.736083984375, 0.743133544921875, 0.750091552734375, 0.7569580078125, 0.763763427734375, 0.770477294921875, 0.777130126953125, 0.783660888671875, 0.790130615234375, 0.7965087890625, 0.80279541015625, 0.808990478515625, 0.815093994140625, 0.821136474609375, 0.827056884765625, 0.8328857421875, 0.838653564453125, 0.84429931640625, 0.849853515625, 0.8553466796875, 0.8607177734375, 0.865997314453125, 0.871185302734375, 0.87628173828125, 0.88128662109375, 0.88616943359375, 0.8909912109375, 0.89569091796875, 0.900299072265625, 0.90478515625, 0.909210205078125, 0.91351318359375, 0.917724609375, 0.921844482421875, 0.92584228515625, 0.92974853515625, 0.933563232421875, 0.937255859375, 0.94085693359375, 0.9443359375, 0.94775390625, 0.951019287109375, 0.9542236328125, 0.957275390625, 0.96026611328125, 0.963134765625, 0.96588134765625, 0.96856689453125, 0.971099853515625, 0.973541259765625, 0.97589111328125, 0.978118896484375, 0.980255126953125, 0.982269287109375, 0.984161376953125, 0.9859619140625, 0.9876708984375, 0.989227294921875, 0.99072265625, 0.992095947265625, 0.99334716796875, 0.994476318359375, 0.99554443359375, 0.9964599609375, 0.997283935546875, 0.99798583984375, 0.99859619140625, 0.99908447265625, 0.999481201171875, 0.999755859375, 0.999908447265625, 0.999969482421875, 0.999908447265625, 0.999755859375, 0.999481201171875, 0.99908447265625, 0.99859619140625, 0.99798583984375, 0.997283935546875, 0.9964599609375, 0.99554443359375, 0.994476318359375, 0.99334716796875, 0.992095947265625, 0.99072265625, 0.989227294921875, 0.9876708984375, 0.9859619140625, 0.984161376953125, 0.982269287109375, 0.980255126953125, 0.978118896484375, 0.97589111328125, 0.973541259765625, 0.971099853515625, 0.96856689453125, 0.96588134765625, 0.963134765625, 0.96026611328125, 0.957275390625, 0.9542236328125, 0.951019287109375, 0.94775390625, 0.9443359375, 0.94085693359375, 0.937255859375, 0.933563232421875, 0.92974853515625, 0.92584228515625, 0.921844482421875, 0.917724609375, 0.91351318359375, 0.909210205078125, 0.90478515625, 0.900299072265625, 0.89569091796875, 0.8909912109375, 0.88616943359375, 0.88128662109375, 0.87628173828125, 0.871185302734375, 0.865997314453125, 0.8607177734375, 0.8553466796875, 0.849853515625, 0.84429931640625, 0.838653564453125, 0.8328857421875, 0.827056884765625, 0.821136474609375, 0.815093994140625, 0.808990478515625, 0.80279541015625, 0.7965087890625, 0.790130615234375, 0.783660888671875, 0.777130126953125, 0.770477294921875, 0.763763427734375, 0.7569580078125, 0.750091552734375, 0.743133544921875, 0.736083984375, 0.72894287109375, 0.72174072265625, 0.714447021484375, 0.70709228515625, 0.69964599609375, 0.692108154296875, 0.684539794921875, 0.676849365234375, 0.669097900390625, 0.661285400390625, 0.653411865234375, 0.64544677734375, 0.63739013671875, 0.629302978515625, 0.621124267578125, 0.612884521484375, 0.604583740234375, 0.596221923828125, 0.5877685546875, 0.579254150390625, 0.570709228515625, 0.56207275390625, 0.553375244140625, 0.54461669921875, 0.535797119140625, 0.526947021484375, 0.51800537109375, 0.509033203125, 0.499969482421875, 0.490875244140625, 0.48175048828125, 0.4725341796875, 0.463287353515625, 0.4539794921875, 0.444610595703125, 0.435211181640625, 0.42578125, 0.416259765625, 0.40673828125, 0.397125244140625, 0.38751220703125, 0.377838134765625, 0.36810302734375, 0.358367919921875, 0.34857177734375, 0.338714599609375, 0.328857421875, 0.318939208984375, 0.30902099609375, 0.299041748046875, 0.289031982421875, 0.27899169921875, 0.2689208984375, 0.258819580078125, 0.248687744140625, 0.238525390625, 0.22833251953125, 0.2181396484375, 0.207916259765625, 0.197662353515625, 0.1873779296875, 0.177093505859375, 0.166778564453125, 0.15643310546875, 0.146087646484375, 0.135711669921875, 0.125335693359375, 0.11492919921875, 0.104522705078125, 0.0941162109375, 0.08367919921875, 0.0732421875, 0.062774658203125, 0.052337646484375, 0.0418701171875, 0.031402587890625, 0.02093505859375, 0.010467529296875, 0.0, -0.010467529296875, -0.02093505859375, -0.031402587890625, -0.0418701171875, -0.052337646484375, -0.062774658203125, -0.0732421875, -0.08367919921875, -0.0941162109375, -0.104522705078125, -0.11492919921875, -0.125335693359375, -0.135711669921875, -0.146087646484375, -0.15643310546875, -0.166778564453125, -0.177093505859375, -0.1873779296875, -0.197662353515625, -0.207916259765625, -0.2181396484375, -0.22833251953125, -0.238525390625, -0.248687744140625, -0.258819580078125, -0.2689208984375, -0.27899169921875, -0.289031982421875, -0.299041748046875, -0.30902099609375, -0.318939208984375, -0.328857421875, -0.338714599609375, -0.34857177734375, -0.358367919921875, -0.36810302734375, -0.377838134765625, -0.38751220703125, -0.397125244140625, -0.40673828125, -0.416259765625, -0.42578125, -0.435211181640625, -0.444610595703125, -0.4539794921875, -0.463287353515625, -0.4725341796875, -0.48175048828125, -0.490875244140625, -0.499969482421875, -0.509033203125, -0.51800537109375, -0.526947021484375, -0.535797119140625, -0.54461669921875, -0.553375244140625, -0.56207275390625, -0.570709228515625, -0.579254150390625, -0.5877685546875, -0.596221923828125, -0.604583740234375, -0.612884521484375, -0.621124267578125, -0.629302978515625, -0.63739013671875, -0.64544677734375, -0.653411865234375, -0.661285400390625, -0.669097900390625, -0.676849365234375, -0.684539794921875, -0.692108154296875, -0.69964599609375, -0.70709228515625, -0.714447021484375, -0.72174072265625, -0.72894287109375, -0.736083984375, -0.743133544921875, -0.750091552734375, -0.7569580078125, -0.763763427734375, -0.770477294921875, -0.777130126953125, -0.783660888671875, -0.790130615234375, -0.7965087890625, -0.80279541015625, -0.808990478515625, -0.815093994140625, -0.821136474609375, -0.827056884765625, -0.8328857421875, -0.838653564453125, -0.84429931640625, -0.849853515625, -0.8553466796875, -0.8607177734375, -0.865997314453125, -0.871185302734375, -0.87628173828125, -0.88128662109375, -0.88616943359375, -0.8909912109375, -0.89569091796875, -0.900299072265625, -0.90478515625, -0.909210205078125, -0.91351318359375, -0.917724609375, -0.921844482421875, -0.92584228515625, -0.92974853515625, -0.933563232421875, -0.937255859375, -0.94085693359375, -0.9443359375, -0.94775390625, -0.951019287109375, -0.9542236328125, -0.957275390625, -0.96026611328125, -0.963134765625, -0.96588134765625, -0.96856689453125, -0.971099853515625, -0.973541259765625, -0.97589111328125, -0.978118896484375, -0.980255126953125, -0.982269287109375, -0.984161376953125, -0.9859619140625, -0.9876708984375, -0.989227294921875, -0.99072265625, -0.992095947265625, -0.99334716796875, -0.994476318359375, -0.99554443359375, -0.9964599609375, -0.997283935546875, -0.99798583984375, -0.99859619140625, -0.99908447265625, -0.999481201171875, -0.999755859375, -0.999908447265625, -0.999969482421875, -0.999908447265625, -0.999755859375, -0.999481201171875, -0.99908447265625, -0.99859619140625, -0.99798583984375, -0.997283935546875, -0.9964599609375, -0.99554443359375, -0.994476318359375, -0.99334716796875, -0.992095947265625, -0.99072265625, -0.989227294921875, -0.9876708984375, -0.9859619140625, -0.984161376953125, -0.982269287109375, -0.980255126953125, -0.978118896484375, -0.97589111328125, -0.973541259765625, -0.971099853515625, -0.96856689453125, -0.96588134765625, -0.963134765625, -0.96026611328125, -0.957275390625, -0.9542236328125, -0.951019287109375, -0.94775390625, -0.9443359375, -0.94085693359375, -0.937255859375, -0.933563232421875, -0.92974853515625, -0.92584228515625, -0.921844482421875, -0.917724609375, -0.91351318359375, -0.909210205078125, -0.90478515625, -0.900299072265625, -0.89569091796875, -0.8909912109375, -0.88616943359375, -0.88128662109375, -0.87628173828125, -0.871185302734375, -0.865997314453125, -0.8607177734375, -0.8553466796875, -0.849853515625, -0.84429931640625, -0.838653564453125, -0.8328857421875, -0.827056884765625, -0.821136474609375, -0.815093994140625, -0.808990478515625, -0.80279541015625, -0.7965087890625, -0.790130615234375, -0.783660888671875, -0.777130126953125, -0.770477294921875, -0.763763427734375, -0.7569580078125, -0.750091552734375, -0.743133544921875, -0.736083984375, -0.72894287109375, -0.72174072265625, -0.714447021484375, -0.70709228515625, -0.69964599609375, -0.692108154296875, -0.684539794921875, -0.676849365234375, -0.669097900390625, -0.661285400390625, -0.653411865234375, -0.64544677734375, -0.63739013671875, -0.629302978515625, -0.621124267578125, -0.612884521484375, -0.604583740234375, -0.596221923828125, -0.5877685546875, -0.579254150390625, -0.570709228515625, -0.56207275390625, -0.553375244140625, -0.54461669921875, -0.535797119140625, -0.526947021484375, -0.51800537109375, -0.509033203125, -0.499969482421875, -0.490875244140625, -0.48175048828125, -0.4725341796875, -0.463287353515625, -0.4539794921875, -0.444610595703125, -0.435211181640625, -0.42578125, -0.416259765625, -0.40673828125, -0.397125244140625, -0.38751220703125, -0.377838134765625, -0.36810302734375, -0.358367919921875, -0.34857177734375, -0.338714599609375, -0.328857421875, -0.318939208984375, -0.30902099609375, -0.299041748046875, -0.289031982421875, -0.27899169921875, -0.2689208984375, -0.258819580078125, -0.248687744140625, -0.238525390625, -0.22833251953125, -0.2181396484375, -0.207916259765625, -0.197662353515625, -0.1873779296875, -0.177093505859375, -0.166778564453125, -0.15643310546875, -0.146087646484375, -0.135711669921875, -0.125335693359375, -0.11492919921875, -0.104522705078125, -0.0941162109375, -0.08367919921875, -0.0732421875, -0.062774658203125, -0.052337646484375, -0.0418701171875, -0.031402587890625, -0.02093505859375, -0.010467529296875};

int sp_osc_create(sp_osc **osc)
{
    *osc = malloc(sizeof(sp_osc));
    return SP_OK;
}

int sp_osc_destroy(sp_osc **osc)
{
  free(*osc);
    return SP_NOT_OK;
}

int sp_osc_init(sp_data *sp, sp_osc *osc, sp_ftbl *ft, SPFLOAT iphs)
{
    osc->freq = 440.0;
    osc->amp = 0.2;
    osc->tbl = ft;
    //osc->iphs = fabs(iphs);
    osc->inc = 0.0;
    // if (osc->iphs >= 0){
//         osc->lphs = ((int32_t)(osc->iphs * SP_FT_MAXLEN)) & SP_FT_PHMASK;
//     }
    return SP_OK;
}

// sp_osc_compute(sp, osc, NULL, &tmp);
int sp_osc_compute(sp_data *sp, sp_osc *osc, SPFLOAT *in, SPFLOAT *out)
{
    sp_ftbl *datatable;
    SPFLOAT amp, freq, step, sr;
    
    datatable = osc->tbl;
    amp = osc->amp; 
    freq = osc->freq; // 401
    sr = sp->sr;
    
    //float arm_linear_interep_table[10]={0,2,4,6,8,10,12,14,16,18};
    // init linear interp instance
    // with table length 600, startpoint 0, steps 1 and datatable ft/ftp
    arm_linear_interp_instance_f32 S = {600, 0, 1, &lewave[0]};
    
    // 1 sine = 600
    // freq = 440
    // sr = 48000
    
    // 48000 / 440 = 109.09 datapoints per sample
    // 0 -> 600 (datatable length)
    // 0 -> 109.1 
    // step = 600 / 109.1 = 18.77
    
    step = osc->inc + (600.0f/(sr/freq));
    if(step>600){
      step-=600;
    }  
    *out = amp * (arm_linear_interp_f32(&S, step));
    osc->inc = step;

    return SP_OK;
}
